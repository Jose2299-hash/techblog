{% extends 'base.html' %}

{% block contenido %}
<div class="max-w-5xl mx-auto px-4">
  <!-- Notificaci√≥n primaria -->
  <div class="bg-blue-100 text-blue-900 rounded-lg p-4 mt-5 shadow">
    <h1 class="text-xl font-bold">{{ post.title }}</h1>
    <p class="mt-1 text-sm text-gray-600">
      <small>{{ post.author }}</small> &nbsp;
      <small>{{ post.date_posted }}</small>
    </p>
  </div>

  <!-- Imagen centrada -->
  <div class="flex justify-center mt-6">
    <figure class="w-[750px] flex justify-center">
      <img src="../../media/{{post.thumbnail}}" alt="Post Thumbnail" class="rounded shadow">
    </figure>
  </div>

  <!-- Contenido del post -->
  <div id="post-content" class="text-lg mt-5 text-justify text-gray-800"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const contenidoGuardado = localStorage.getItem('post_content');
    const contenedor = document.getElementById('post-content');
    
    if (contenidoGuardado) {
      contenedor.innerHTML = contenidoGuardado;
    } else {
      contenedor.innerHTML = '<p>No hay contenido guardado.</p>';
    }
  });
</script>
    <form action="{% url 'all_posts' %}" class="mt-6">
        <button class="button is-link is-light is-small is-outlined" type="submit">Regresar al Home</button>
    </form>

    <!-- Zona de comentarios -->
    <div class="box mt-6">
        <h2 class="title is-5">Agregar comentario</h2>

        <!-- Estrellas -->
<div id="rating-stars" class="mb-4 flex gap-2">
  <label class="flex items-center gap-1">
    <input type="radio" name="rating" value="1" class="accent-yellow-500"> ‚≠ê
  </label>
  <label class="flex items-center gap-1">
    <input type="radio" name="rating" value="2" class="accent-yellow-500"> ‚≠ê‚≠ê
  </label>
  <label class="flex items-center gap-1">
    <input type="radio" name="rating" value="3" class="accent-yellow-500"> ‚≠ê‚≠ê‚≠ê
  </label>
  <label class="flex items-center gap-1">
    <input type="radio" name="rating" value="4" class="accent-yellow-500"> ‚≠ê‚≠ê‚≠ê‚≠ê
  </label>
  <label class="flex items-center gap-1">
    <input type="radio" name="rating" value="5" class="accent-yellow-500"> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
  </label>
</div>

<!-- Editor -->
<textarea id="editor" class="w-full h-32 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400 focus:outline-none resize-none" placeholder="Escribe tu comentario aqu√≠..."></textarea>

<!-- Botones -->
<div class="mt-4 flex gap-3">
  <input type="file" id="archivo-adjunto" class="hidden" onchange="procesarArchivo(event)">
  
  <button type="button"
          onclick="document.getElementById('archivo-adjunto').click()"
          class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition">
    Agregar archivo
  </button>

  <button type="button"
          onclick="publicarComentario(event)"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
    Publicar comentario
  </button>
</div>

    <!-- Comentarios publicados -->
    <div id="comentarios-publicados" class="mt-5"></div>

    <!-- CKEditor -->
    <script src="https://cdn.jsdelivr.net/npm/@ckeditor/ckeditor5-build-classic@39.0.1/build/ckeditor.js"></script>

    <!-- L√≥gica de comentarios -->
<script>
    let editorInstance;

    ClassicEditor.create(document.querySelector('#editor')).then(editor => {
        editorInstance = editor;
        cargarComentarios();
    });

    function generarID() {
        return '_' + Math.random().toString(36).substr(2, 9);
    }

    function procesarArchivo(event) {
        const archivo = event.target.files[0];
        if (!archivo) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            if (archivo.type.startsWith('image/')) {
                editorInstance.model.change(writer => {
                    const imageElement = writer.createElement('imageBlock', {
                        src: e.target.result
                    });
                    editorInstance.model.insertContent(imageElement, editorInstance.model.document.selection);
                });
            } else {
                const enlace = `<a href="${e.target.result}" download="${archivo.name}">üìé Descargar archivo: ${archivo.name}</a>`;
                editorInstance.model.change(writer => {
                    const viewFragment = editorInstance.data.processor.toView(enlace);
                    const modelFragment = editorInstance.data.toModel(viewFragment);
                    editorInstance.model.insertContent(modelFragment, editorInstance.model.document.selection);
                });
            }
        };
        reader.readAsDataURL(archivo);
    }

    function publicarComentario(event) {
        event.preventDefault();

        const contenido = editorInstance.getData();
        const ratingInput = document.querySelector('input[name="rating"]:checked');

        if (!contenido.trim()) {
            alert("Por favor escribe un comentario.");
            return;
        }

        if (!ratingInput) {
            alert("Selecciona una calificaci√≥n de estrellas.");
            return;
        }

        const comentario = {
            id: generarID(),
            contenido: contenido,
            rating: parseInt(ratingInput.value),
            fecha: new Date().toLocaleString(),
            respuestas: []
        };

        guardarComentarioLocal(comentario);
        renderComentario(comentario);

        editorInstance.setData("");
        ratingInput.checked = false;
    }

    function guardarComentarioLocal(comentario) {
        let comentarios = JSON.parse(localStorage.getItem("comentarios")) || [];
        comentarios.push(comentario);
        localStorage.setItem("comentarios", JSON.stringify(comentarios));
    }

    function eliminarComentario(id) {
        if (!confirm("¬øEst√°s seguro de eliminar este comentario?")) return;

        let comentarios = JSON.parse(localStorage.getItem("comentarios")) || [];
        comentarios = comentarios.filter(c => c.id !== id);
        localStorage.setItem("comentarios", JSON.stringify(comentarios));
        document.getElementById(id).remove();
    }

    function cargarComentarios() {
        const comentarios = JSON.parse(localStorage.getItem("comentarios")) || [];
        comentarios.forEach(renderComentario);
    }

    function renderComentario(comentario) {
        const div = document.createElement("div");
        div.classList.add("box", "mt-4");
        div.id = comentario.id;

        const estrellas = '‚≠ê'.repeat(comentario.rating);
        div.innerHTML = `
            <div><strong>Calificaci√≥n:</strong> ${estrellas}</div>
            <div class="has-text-grey-light"><small>${comentario.fecha}</small></div>
            <div class="content mt-2">${comentario.contenido}</div>
            <button class="button is-danger is-small mt-2" onclick="eliminarComentario('${comentario.id}')">Eliminar</button>
            <button class="button is-info is-small mt-2" onclick="mostrarFormularioRespuesta('${comentario.id}')">Responder</button>
            <div id="respuestas-${comentario.id}" class="mt-3"></div>
        `;

        // Si el comentario tiene respuestas, renderizarlas
        comentario.respuestas.forEach(respuesta => {
            renderRespuesta(comentario.id, respuesta);
        });

        document.getElementById("comentarios-publicados").appendChild(div);
    }

    function renderRespuesta(comentarioID, respuesta) {
        const div = document.createElement("div");
        div.classList.add("box", "mt-2");
        div.id = respuesta.id; // A√±adimos un id √∫nico para cada respuesta
        div.innerHTML = `
            <div><strong>Respuesta:</strong></div>
            <div class="content mt-2">${respuesta.contenido}</div>
            <div class="has-text-grey-light"><small>${respuesta.fecha}</small></div>
            <button class="button is-danger is-small mt-2" onclick="eliminarRespuesta('${comentarioID}', '${respuesta.id}')">Eliminar Respuesta</button>
        `;
        document.getElementById(`respuestas-${comentarioID}`).appendChild(div);
    }

    function mostrarFormularioRespuesta(comentarioID) {
        const divFormulario = document.createElement("div");
        divFormulario.innerHTML = `
            <textarea id="respuesta-editor-${comentarioID}" class="textarea" placeholder="Escribe tu respuesta aqu√≠..."></textarea>
            <button class="button is-info mt-2" onclick="publicarRespuesta('${comentarioID}')">Publicar Respuesta</button>
        `;
        document.getElementById(`respuestas-${comentarioID}`).appendChild(divFormulario);
    }

    function publicarRespuesta(comentarioID) {
        const contenido = document.getElementById(`respuesta-editor-${comentarioID}`).value;

        if (!contenido.trim()) {
            alert("Por favor escribe una respuesta.");
            return;
        }

        const respuesta = {
            id: generarID(),
            contenido: contenido,
            fecha: new Date().toLocaleString()
        };

        let comentarios = JSON.parse(localStorage.getItem("comentarios")) || [];
        const comentario = comentarios.find(c => c.id === comentarioID);
        comentario.respuestas.push(respuesta);
        localStorage.setItem("comentarios", JSON.stringify(comentarios));

        renderRespuesta(comentarioID, respuesta);
        document.getElementById(`respuesta-editor-${comentarioID}`).value = "";
    }

    function eliminarRespuesta(comentarioID, respuestaID) {
        if (!confirm("¬øEst√°s seguro de eliminar esta respuesta?")) return;

        let comentarios = JSON.parse(localStorage.getItem("comentarios")) || [];
        const comentario = comentarios.find(c => c.id === comentarioID);
        comentario.respuestas = comentario.respuestas.filter(r => r.id !== respuestaID);
        localStorage.setItem("comentarios", JSON.stringify(comentarios));

        document.getElementById(respuestaID).remove();
    }



    
</script>
</div>
<!-- Agregar el CSS personalizado -->
<style>
    /* Estilo para el contenedor de comentarios */
    .box {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .box:hover {
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
    }

    /* Ajustes de dise√±o */
    textarea {
        background-color: #f9fafb; /* Color claro de fondo para el textarea */
        border-radius: 8px;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Modo oscuro */
    .dark textarea {
        background-color: #4a5568;
        color: #edf2f7; /* Texto claro en modo oscuro */
    }
</style>
{% endblock %}